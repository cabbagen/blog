
#### 一、概要

mysql 性能优化就是通过合理的安排资源，调整系统参数使 mysql 运行更快、更节省资源。mysql 性能优化包括查询速度优化、数据库结构优化、mysql 服务器优化。   


mysql 的优化，一方面是找出系统的瓶颈，提高 mysql 数据库整体的性能；另一方面需要合理的结构设计和参数调整，以提高用户操作响应的速度；同时还要尽可能节省系统的资源，以便系统可以提供更大负载的服务。


#### 二、优化查询

> 分析查询语句

````
EXPLAIN [EXTENDED] SELECT select_options

// 使用 EXTENDED 关键字，EXPLAIN 语句将产生附加信息。
// select_options 时 SELECT 语句的查询选项，包括 FROM WHERE 字句等
// 执行该语句，可以分析 EXPLAIN 后面的 SELECT 语句的执行情况，并且能够分析出所查询表的一些特征。
````

> 索引对查询速度的影响

mysql 中提高性能的一个最有效的方式就是对数据表设计合理的索引。索引提供了高效访问数据的方法，并且加快查询的速度，因此，索引对查询的速度有着至关重要的影响。使用索引可以快速地定位表中的某条记录，从而提高数据库查询的速度，提高数据库性能。


如果查询时没有使用索引，查询语句将扫描表中的所有记录。在数据量大的情况下，这样查询的速度会很慢。如果使用索引进行查询，查询语句可以根据索引快速定位到待查询记录，从而减少查询记录数，达到提高查询速度的目的。


索引可以提高查询速度。但并不是使用带有索引字段查询时，索引都会起作用。一下的状况除外：

* 在使用 LIKE 关键字进行查询的查询语句中，如果匹配的字符串的第一个字符为 “%”，索引不会起作用。只有 “%” 不在第一个位置，索引才会起作用。

* mysql 可以为多个字段创建索引。一个索引可以包括 16 个字段。对于多列索引，只有查询条件中使用了这些字段中第一个字段时，索引才会被使用。

* 查询语句的查询条件中只有 OR 关键字，且 OR 前后的两个条件的列都是索引时，查询中才使用索引。否则，查询将不使用索引。

> 优化子查询

使用子查询可以进行 SELECT 语句的嵌套查询，即一个 SELECT 查询的结果作为另一个 SELECT 语句的条件。子查询可以一次性完成很多逻辑上需要多个步骤才能完成的 sql 操作。子查询虽然可以使查询语句很灵活，但是执行效率不高。执行子查询时，mysql 需要为内层查询语句的查询结果建立一个临时的表。然后外层查询语句从临时表中查询记录。查询完毕后，再撤销这些临时表。因此，子查询的速度会受到一定的影响。如果查询的数据量比较大，这种影响就会随之增大。


在 mysql 中，可以使用链接（JOIN）查询来代替子查询。连接查询不需要建立临时表，其速度比子查询要快，如果查询中使用索引的话，性能会更好。连接之所以更有效率，是因为 mysql 不需要在内存中创建临时表来完成查询工作。


#### 三、优化数据库结构

一个好的数据库设计方案对于数据库的性能常常会起到事半功倍的效果。合理的数据库结构不仅可以使数据库占用更小的磁盘空间，而且能够使查询速度更快。数据库结构的设计，需要考虑数据冗余、查询和更新的速度、字段的数据类型是否合理等多方面内容。

> 将字段很多的表分解成多个表

对于字段较多的表，如果有些字段的使用频率很低，可以将这些字段分离出来形成新表。因为当一个表的数据很大时，会由于使用频率低的字段存在而变慢。

> 增加中间表

对于需要经常联合查询的表，可以建立中间表以提高查询效率。通过建立中间表，把需要经常联合查询的数据插入到中间表中，然后将原来的联合查询改为对中间表的查询，以此来提高查询效率。

> 增加冗余字段

设计数据库表时应尽量遵循范式理论，尽可能减少冗余字段，让数据库设计看起来精致、优雅。但是，合理的加入冗余字段可以提高查询速度。

表的规范化程度越高，表与表之间的关系就越多，需要连接查询的情况也就越多。如果经常需要进行这个操作，连接查询会浪费很多时间。使用冗余字段可以减少连接的使用。

冗余字段会导致一些问题。比如，冗余字段的值在一个表中被修改了，就要想办法在其他表中更新该字段。否则就会使原本一致的数据变得不一致。分解表、增加中间表和增加冗余字段都浪费了一定的磁盘空间。从数据库性能看，为了提高查询速度而增加少量的冗余大部分时候是可以接受的。是否通过增加冗余来提高数据库性能，这要根据实际需求来综合分析。

> 优化插入记录的速度

插入记录时，影响插入速度的主要是索引、唯一性校验、以此插入记录条数等。根据这些情况，可以分别进行优化。

对于 MyISAM 引擎的表

* 禁用索引   
对于非空表，插入记录时，mysql 会根据表的索引对插入的记录建立索引。如果插入大量数据，建立索引会降低插入记录的速度。为了解决这种情况，可以在插入记录之前禁用索引，数据插入完毕后在开启索引。
````
// 禁用索引
ALTER TABLE table_name DISABLE KEYS;
// 开启索引
ALTER TABLE table_name ENABLE KEYS;
````

* 禁用唯一性检查
插入数据时，mysql 会对插入的记录进行唯一性校验。这种唯一性校验也会降低插入记录的速度。为了降低这种情况对查询速度的影响，可以在插入记录之前禁用唯一性检查，等到记录插入完毕后再开启。
````
SET UNIQUE_CHECKS = 0;
SET UNIQUE_CJECKS = 1;
````
* 使用批量插入

* 使用 LOAD DATA INFILE 批量导入
当需要批量导入数据时，如果能用 LOAD DATA INFILE 语句，就尽量使用。因为 LOAD DATA INFILE 语句导入数据的速度比 INSERT 语句快。

对于 InnoDB 引擎的表

* 禁用唯一性检查

* 禁用外键检查
插入数据之前执行禁止对外键的检查，数据插入完成之后再恢复对外键的检查。
````
SET foreign_key_checks = 0;
SET foreign_key_checks = 1;
````
* 禁止自动提交
插入数据之前禁止事务的自动提交，数据导入完成之后，执行恢复自动提交操作。
````
set autocommit = 0;
set autocommit = 1;
````

> 分析表、检查表和优化表

mysql 提供了分析表、检查表和优化表的语句。分析表主要是分析关键字的分布；检查表主要是检查是否存在错误；优化表主要是消除删除或者更新造成的空间浪费。

分析表

````
ANALYZE [LOCAL | NO_WRITE_TO_BINLOG] TABLE tbl_name [, tbl_name]...
````

检查表

mysql中可以使用 CHECK TABLE 语句来检查表。CHECK TABLE 语句能够检查 InnoDB 和 MyISAM 类型的表是否存在错误。对于 MyISAM 类型的表，CHECK TABLE 语句还会更新关键字统计数据。而且，CHECK TABLE 也可以检查视图是否有错误，比如在视图定义中被引用的表以不存在。

````
CHECK TABLE tbl_name [, tbl_name] ... [option] ...
option = {QUICK | FAST | MEDIUM | EXTENDED | CHANGED}
````

优化表

mysql 中使用 OPTIMIZE TABLE 语句来优化表。该语句对 InnoDB 和 MyISAM 类型的表都有效。但是，OPTIMIZE TABLE 语句只能优化表中的 VARCHAR、BLOB、或 TEXT 类型的字段。

````
OPTIMIZE [LOCAL | NO_WRITE_TO_BINLOG] TABLE tbl_name, [, tbl_name] ...
````
通过 OPTIMIZE TABLE 语句可以消除删除和更新造成的文件碎片。OPTIMIZE TABLE 语句在执行过程中也会给表加上只读锁。

一个表使用 TEXT 或者 BLOB 这样的数据类型，如果已经删除了表的一大部分，或者已经对含有可变长度行的表（含有 VARCHAR，BLOB，TEXT 列的表）进行了很多更新，则应使用 OPTIMIZE TABLE 来重新利用未使用的空间，并整理数据文件的碎片。在多数的设置中，根本不需要运行 OPTIMIZE TABLE。即使对可变长度的行进行了大量的更新，也不需要经常运行，每周一次或每月一次即可，并且只需要对特定的表运行。

#### 四、优化 mysql 服务器

> 优化服务器硬件

* 配置较大的内存。足够大的内存，是提高mysql数据库性能的方法之一。内存的速度比磁盘I/O快的多，可以通过增加系统的缓冲区容量，是数据在内存停留的时间更长，以减少磁盘 I/O。

* 配置高速磁盘系统，以减少读盘的等待时间，提高响应速度。

* 合理分布磁盘I/O，把磁盘I/O分散在多个设备上，以减少资源竞争，提高并行操作能力。

* 配置多处理器，mysql 是多线程的数据库，多处理器可以同时执行多个线程。

> 优化mysql参数

通过优化 mysql 的参数可以提高资源利用率，从而达到提高mysql服务器性能的目的。mysql 服务的配置参数都在 my.cnf 或者 my.ini 文件的 [MySQLd] 组中。

