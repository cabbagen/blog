
在 mongodb 中，一个复制集就是一组 mongod 的进程。它们提供了数据冗余和高可用性。一般包括以下三种：primary、 secondaries、 arbiter。


#### 一、primary

在 mongodb 的复制集中，primary 是唯一个可以执行 写操作 的节点。
在执行操作的时候，他会将操作记录在 oplog 文件。
secondary 节点调用这些记录，在自己的副本集数据中执行相应的操作，保持与 primary 数据的一致性。

默认状态下，客户端默认会从 primary 上读取数据，如果需要从 secondary 节点中读取数据，可以进行额外的配置。

当 primary 成员不可用时，secondary 节点间会进行选举，选择出另一个 primary 节点。在这期间数据库只能执行 读操作， 而不能执行 写操作。


#### 二、secondary

**作为备用的优先级为 0 的 secondary 节点（ Priority 0 Replica Set Members）**     

优先级为 0 的节点不能成为 primary ，并且也不能触发选举。除了这些的限制，它包含了数据集合的副本，能够执行 读操作，并且能够在选举中进行投票。

在大多数情况下，并不需要将 secndary 节点的 优先级 设置为 0。然而，由于硬件条件的限制，当我们需要只令某些 secndary 节点可称为 primary 节点时，这将是特别有用的。

将辅助节点配置为具有优先级 0 时，请考虑潜在的故障切换模式，包括所有可能的网络分区。
始终确保你的主数据中心既包含法定人数的投票成员，又包含有资格成为主要成员的成员。


**隐藏的 secondary 节点（Hidden Replica Set Members）**

一个隐藏的节点包含了 primary 数据的副本，但是对于客户端程序来说却是不可见的。
隐藏的节点适用于具有与副本集中其他节点不同使用模式的工作负载。
隐藏的节点必须优先级设置为 0，因此也不能成为主键，但是可以在选举中投票。

下面是有五个节点的副本集，4 个具有 primary 数据的副本，但是其中有一个是隐藏的。

![image](https://docs.mongodb.com/manual/_images/replica-set-hidden-member.bakedsvg.svg)


客户端并不会带有读偏好的读操作分发给隐藏的节点。因此，处理基本的复制操作，他们并不会接收其他的流量。使用隐藏节点主要是为了专业的任务，像是报告和备份。

隐藏的节点可以在选举中进行投票，如果需要停止一个隐藏节点的投票，需要确保这个副本集中要还存活着大多数节点或 primary 将要下线。


**延迟的 secondary 节点 （Delayed Replica Set Members）**    

延迟节点包含了数据集的数据集的副本。然而，一个延迟节点设置了一个数据集状态更早时间的反映（reflects）。
例如当前时间是 09:52, 并且一个节点有一个一小时的延迟，延迟的节点没有比 08:52 更近时间的操作。

由于 延迟节点 是一个数据集合的历史快照，他可能帮助你恢复历史数据。
例如，延迟节点可以从不成功的应用程序升级和操作员错误（包括丢弃的数据库和集合）中恢复。

延迟节点注意事项：

* 必须是一个优先级为 0 的节点

* 必须是一个隐藏的节点

* 如果 members[n].votes 设置为 1， 便能够在选举中进行投票 

延迟节点的行为：

延迟节点从 oplog 上拷贝并执行操作，当选择延迟时长时，应该考虑下面的情况。

* 必须等于或大于您的预期维护时长

* 必须小于oplog的容量

![image](https://docs.mongodb.com/manual/_images/replica-set-delayed-member.bakedsvg.svg)


#### 三、arbiter

一个仲裁节点并没有数据的拷贝并且不能成为 primary 节点，它只能在 primary 节点的选举中进行投票。
仲裁节点总是有一次选举投票的机会，因此允许副本集具有不定数量的投票成员，而没有额外的性能开销。


#### 四、配置副本集节点

将 “大多数” 节点放在同一个数据中心。如果有一个主数据中心，而且你希望副本集的主节点总是位于主数据中心的话，这样配置会比较好。只要主数据中心能够正常运转，就会有一个主节点。但是，如果主数据中心不可用了，那么备份数据中心的成员无法选举出主节点。

![image](../images/2018-06-20_173743.jpg)

在两个数据中心各自放置数量相等的成员，在第三个地方放置一个用于决定胜负的副本集成员。如果两个数据中心同等重要，那么这种配置会比较好。因为任意一个数据中心的服务器都可以找到另一台服务器以达到“大多数”。但是，这样就需要将服务器分散到三个地方。

更复杂的需求需要使用不同的配置，一定要考虑清楚，出现不利情况时，副本集要如何达到“”“大多数”的要求

