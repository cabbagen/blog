
#### 一、复制集部署架构

在生产环境中，标准的复制集有 3 个成员节点。这样的配置提供了数据冗余与适当的容错。尽可能的避免复杂，让应用程序需求决定你的架构。


#### 二、复制集的部署策略

在一个复制集中添加成员节点将遵循下面的策略

* 投票节点的最大数量

> 一个复制集最多有 50 个成员节点，而仅仅有 7 个 投票节点（voting members）。如果一个复制集中早已有了 7 个 投票节点，另外的节点必须是非投票节点。


* 复制集节点为 奇数

> 确保复制集有一个奇数的投票节点。如果你有一个偶数的投票节点，那么部署一个 仲裁节点（arbiter），以致有一个奇数的投票节点。

> 一个 仲裁节点（arbiter）并不会拷贝数据或者请求资源，因此，你可以在一个应用服务或者其他共享的进程上运行一个 仲裁节点。因为它们不会复制数据，你可以把仲裁节点与复制集其他的成员节点分开来放。


* 考虑容错

> 副本集的容错性是指当副本集中的成员变得不可用时，仍然能够留有足够的节点来选举出主节点（primary）。换句话说，它是复制集成员的数量和选举一个主节点所需节点的数目间的不同。没有一个主节点，复制集将不能写入数据。容错是副本集大小的一种影响，但关系不是直接的。

![image](../images/8d880d4c999d4db1be364a7be7cae5a1.jpg)

> 在复制集中，添加一个成员节点并不总是增加了容错。然而在某些情况下，添加成员节点是为了一些特殊的功能，例如备份或者报告。


* 使用隐藏节点和延迟节点为了专有的功能

> 使用隐藏节点（hidden）和延迟节点（delayed）为了专有的功能。例如备份或报告


* 在具有大量读取需求的部署中，注意负载均衡

> 在读取流量非常高的部署中，你可以通过将读取次要节点（secondary）来提高读取吞吐量，随着部署的增长，将成员节点添加或者移动到备用数据中心以提高冗余性和可用性。

> 注意：通过两个数据中心来分发复制集成员节点比一个数据中心更加有效率。在两个数据中心的情况下

> * 如果一个数据中心不可用了，数据仍然能够从另一个复制集中读取数据
> * 如果那个拥有少量成员节点的数据中心不可用了，那么这个复制集还是执行写操作和读操作的。
> * 如果那个拥有大多数成员节点的数据中心不可用了，那么这个复制集将会变成一个只读的复制集。

> 如果可能的话，分发至少三个数据中心的节点成员。对于配置服务器副本集（CSRS），最佳实践是跨三个（或更多，取决于成员数量）中心进行分配。如果第三个数据中心的成本过高，一种分布可能性是在两个数据中心间均匀分配数据承载成员，并将剩余成员（数据承载成员或仲裁者，以确保奇数个成员）存储在云（如果你的公司政策允许）。

> 总是确保能够选择一个主节点（primary）


* 增加需求容量

> 在那些存在成员节点的复制集中必须有备用的容量去支持添加一个新的成员节点。在当前需求满足之前，总是能够添加新的成员节点。


* 按地理位置分发成员节点

> 为了在数据中心出现故障时保护您的数据，请至少将一位成员保留在备用数据中心中。如果可能，请使用奇数个数据中心，并选择一个成员分布，以最大限度地发挥数据中心丢失的可能性，其余副本集成员可以形成大多数或至少一个数据中心，提供数据副本

> 注意：通过两个数据中心来分发复制集成员节点比一个数据中心更加有效率。在两个数据中心的情况下

> * 如果一个数据中心不可用了，数据仍然能够从另一个复制集中读取数据
> * 如果那个拥有少量成员节点的数据中心不可用了，那么这个复制集还是执行写操作和读操作的。
> * 如果那个拥有大多数成员节点的数据中心不可用了，那么这个复制集将会变成一个只读的复制集。

> 如果可能的话，分发至少三个数据中心的节点成员。对于配置服务器副本集（CSRS），最佳实践是跨三个（或更多，取决于成员数量）中心进行分配。如果第三个数据中心的成本过高，一种分布可能性是在两个数据中心间均匀分配数据承载成员，并将剩余成员（数据承载成员或仲裁者，以确保奇数个成员）存储在云（如果你的公司政策允许）。

* 使用标记集的目标操作

* 使用日记功能来防止电源故障

> mongodb 默认启用日志记录。日志可防止服务中断时出现数据丢失，如电源故障和意外重启。
 
 
#### 三、三个成员的复制集

* 一个主节点（primary）和两个次要节点（secondary）

 ![image](https://docs.mongodb.com/manual/_images/replica-set-primary-with-two-secondaries.bakedsvg.svg)
 
 ![image](https://docs.mongodb.com/manual/_images/replica-set-trigger-election.bakedsvg.svg)

* 一个主节点（primary）一个次要节点（secondary）和一个仲裁节点（arbiter）

![image](https://docs.mongodb.com/manual/_images/replica-set-primary-with-secondary-and-arbiter.bakedsvg.svg)

![image](https://docs.mongodb.com/manual/_images/replica-set-w-arbiter-trigger-election.bakedsvg.svg)


#### 四、副本集分布在两个或者多个数据中心

虽然副本集为单例故障提供了基本的保护，但是副本集的成员都位于单个数据中心中，当数据中心故障的时候，这将会导致副本集的受到影响。当发生停电，网络和自然灾害等情况时，一个把所有成员节点都存储在的单一设备的复制集将很容易受到影响。

在不同地理位置的数据中心之间分布副本集成员会可以加冗余，并在其中一个数据中心不可用时提供容错功能。

为了在数据中心出现故障时保护您的数据，请至少将一位成员保留在备用数据中心中。如果可能，请使用奇数个数据中心，并选择一个成员分布。其余副本集成员可以形成大多数或至少一个数据中心，提供你数据的副本。


##### 成员限制

副本集的一些成员节点，例如一些成员节点有网络克制或资源有限，并不能够成为主节点（primary）， 优先级为 0 的节点也不能成为主节点（primary）

##### 链接

验证您的网络配置是否允许所有成员进行通信;即每个成员必须能够连接到每个其他成员。


#### 五、多个数据中心示例

**对于一个三个成员的副本集，一些可能的成员分布包括：**

两个数据中心：数据中心1的两个成员和数据中心2的一个成员。如果副本集的其中一个成员是仲裁者，则使用数据承载成员将仲裁者分发到数据中心1。如果数据中心1出现故障，副本集将变为只读状态。 如果数据中心2出现故障，则由于数据中心1中的成员可以举行选举，因此副本集仍可写入。
    
三个数据中心：一个成员到数据中心1，一个到数据中心2，一个到数据中心3。 如果任何数据中心出现故障，则其余成员可以进行选举，因此副本集仍可写入。


**对于具有五个成员的副本集，成员的一些可能的分布包括：**   

两个数据中心：三个成员到数据中心1和两个成员到数据中心2。 如果数据中心1出现故障，副本集将变为只读状态。如果数据中心2出现故障，则由于数据中心1中的成员可以创建大多数，所以副本集保持可写入状态。      

三个数据中心：两个成员到数据中心1，两个到数据中心2，一个到数据中心3。 如果任何数据中心出现故障，则其余成员可以进行选举，因此副本集仍可写入。

