
#### 一、复制集的高可用性

复制集通过使用选举来实现他们的高可用性。


#### 二、复制集选举

复制集使用选举来决定那一个成员能够成为主节点（primary），当发生下面的情况时，复制集将会自动地触发一次选举。

* 为复制集添加一个新的节点

* 初始化一个复制集

*  当调用 **rs.stepDown()** 或者 **rs.reconfig()** 设置复制集的时候。

*  次要节点失去了同主节点或者其他次要节点的联系。（心跳超时）


在下面的图中，主节点超过配置的超时时间不可使用，并且触发了自动容错进程。其余的次要节点选举了一个新的主节点，并且自动恢复了正常的功能。

![image](https://docs.mongodb.com/manual/_images/replica-set-trigger-election.bakedsvg.svg)

在复制集完成选举之前，复制集不能够执行写操作。但是，如果配置了可在次要节点上读取数据，那么这个复制集仍然能执行读操作。

在应用默认的副本集配置的情况下，在选取一个新主节点之前的中位时间一般不超过 12 秒，可以通过 **settings.electionTimeoutMillis** 进行配置。网络延迟等因素可能会延迟完成复制集选举所需的时间，这反过来又会影响你的集群在没有主服务器的情况下运行的时间。这些因素取决于你特定的集群架构。

你应用程序的链接逻辑应该对自动容错和随后的选举保持兼容。


#### 三、影响选举的因素

* 复制选举协议

* 心跳
> 复制集成员给任意一个成员每 2 秒中发送心跳。如果心跳在 10 秒内没有收到回复，其他成员节点将违规的成员节点标记为不可访问。

* 成员优先级
> 选举算法一般会令优先级较高的次要节点发起一次选举，并且该节点一般也会成为主节点。但是，也可能选择一个优先级较低的节点作为短时间的主节点，这时，复制集成员会继续发起选举直到有较高优先级的成员节点成为主节点。最后，成员的优先级也会影响到选举的时间和结果。

> 优先级为 0 的节点不能成为主节点，并且不能发起选举。

* 失去数据中心
> 对于分布式的复制集， 如果数据中心不可用，可能会影响到其他数据中心的成员或者是数据中心去选择一个主节点。

> 如果可能的话，尽可能的跨数据中心来分布式部署复制集以减少数据中心的丢失，其余的复制集成员能够选举出一个新的主节点。

* 网络分区
> 网络分区可能会将主节点分隔成少数节点的分区。当主节点检测到他只能看到副本集中的少数节点时，主节点将会降级并成为次要节点。独立地，在分区中的节点能够与多数的节点（包括其本身）通信，并且能够发起选举成为新的主节点。

* 在选举中否决
 
* 投票节点和不能投票的节点

> 在下面的图中共有 9 个成员节点，其中有 7 个能够选举的节点，2 个不能选举的节点。

> ![image](https://docs.mongodb.com/manual/_images/replica-set-only-seven-voting-members.bakedsvg.svg)


#### 四、复制集容错回退

当成员节点在故障转移之后重新加入复制集的时候，在之前的 primary 节点会进行回退，恢复之前的写操作。只有在主节点已经接受了写操作，而次要节点还未复制相关操作的时候，回退才是必要的。当主节点以作为次要节点重新加入复制集时，它被恢复或者回退。它的写操作和其他成员节点保持一致。

mongodb 试图避免回退，这应该是很少见的。当回退发生的时候，它通常是网络分区的原因。次要节点并不能赶上之前主节点操作的吞吐量，增加回退的大小和影响。

在主节点降级之前并且大部分节点仍可以访问的情况下，如果写操作已经复制给了复制集中的其他成员节点，那么回退将不会发生。


#### 五、收集回退数据

当回退发生的时候，mongodb 会将回退的数据写到 BSOB 文件中，放在 **dbpath/rollback** 目录下。

#### 六、避免复制集回退

* 对于默认的复制集来说，只提供了在主节点写入的权限。在默认情况下，如果主节点在他的的写操作还没有复制到次要节点之前降级，那么数据可能会回退。

* 为了防止已向客户端确认的数据回滚，请运行启用了日记功能的所有投票成员，并使用 **w：majority write** 关注，以确保写操作传播到大多数副本集节点，然后将确认返回给发放客户端。

#### 六、回退限制

一个mongod实例不会回滚超过300兆字节的数据。如果您的系统必须回滚超过300兆字节，则必须手动干预才能恢复数据

